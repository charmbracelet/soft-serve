# vi: set ft=conf

# convert crlf to lf on windows
[windows] dos2unix info1.txt info2.txt tree.txt

# start soft serve
exec soft serve &
# wait for SSH server to start
ensureserverrunning SSH_PORT

# import a repo
soft repo import --mirror charmbracelet/wizard-tutorial https://github.com/charmbracelet/wizard-tutorial.git

# check empty description file
readfile $DATA_PATH/repos/charmbracelet/wizard-tutorial.git/description ''

# check repo info
soft repo info charmbracelet/wizard-tutorial
cmp stdout info1.txt

# check repo list
soft repo list
stdout charmbracelet/wizard-tutorial

# is-mirror?
soft repo is-mirror charmbracelet/wizard-tutorial
stdout true

# set project name
soft repo project-name charmbracelet/wizard-tutorial wizard-tutorial
soft repo list
stdout wizard-tutorial


# check description
soft repo description charmbracelet/wizard-tutorial
! stdout .

# set description
soft repo description charmbracelet/wizard-tutorial "testing repo"
soft repo description charmbracelet/wizard-tutorial
stdout 'testing repo'
readfile $DATA_PATH/repos/charmbracelet/wizard-tutorial.git/description 'testing repo'

# rename
soft repo rename charmbracelet/wizard-tutorial charmbracelet/test
soft repo list
stdout charmbracelet/test # TODO: shouldn't this still show the project-name?

# check its not private
soft repo private charmbracelet/test
stdout false
exists $DATA_PATH/repos/charmbracelet/test.git/git-daemon-export-ok

# make it private
soft repo private charmbracelet/test  true
soft repo private charmbracelet/test
stdout true
! exists $DATA_PATH/repos/charmbracelet/test.git/git-daemon-export-ok

# check its not hidden
soft repo hidden charmbracelet/test
stdout false

# make it hidden
soft repo hidden charmbracelet/test  true
soft repo hidden charmbracelet/test
stdout true

# print tree
soft repo tree charmbracelet/test
cmp stdout tree.txt

# check repo info again
soft repo info charmbracelet/test
cmp stdout info2.txt

# get a file
soft repo blob charmbracelet/test README.md
stdout '.*Wizard.*'

# stop the server
[windows] stopserver
[windows] ! stderr .


-- info1.txt --
Project Name:
Repository: charmbracelet/wizard-tutorial
Description:
Private: false
Hidden: false
Mirror: true
Owner: admin
Default Branch: main
Branches:
  - main
-- info2.txt --
Project Name: wizard-tutorial
Repository: charmbracelet/test
Description: testing repo
Private: true
Hidden: true
Mirror: true
Owner: admin
Default Branch: main
Branches:
  - main
-- tree.txt --
-rw-r--r--	10 B	 .gitignore
-rw-r--r--	1.3 kB	 README.md
-rw-r--r--	970 B	 go.mod
-rw-r--r--	5.3 kB	 go.sum
-rw-r--r--	2.2 kB	 input.go
-rw-r--r--	2.9 kB	 main.go
