# vi: set ft=conf

# convert crlf to lf on windows
[windows] dos2unix info1.txt info2.txt tree.txt

# start soft serve
exec soft serve &
# wait for SSH server to start
ensureserverrunning SSH_PORT

# import a repo
# TODO: this repo changes all the time, which will also break the tests.
# Should probably use something else.
soft repo import --mirror charmbracelet/catwalk https://github.com/charmbracelet/catwalk.git

# check empty description file
readfile $DATA_PATH/repos/charmbracelet/catwalk.git/description ''

# check repo info
soft repo info charmbracelet/catwalk
cmp stdout info1.txt

# check repo list
soft repo list
stdout charmbracelet/catwalk

# is-mirror?
soft repo is-mirror charmbracelet/catwalk
stdout true

# set project name
soft repo project-name charmbracelet/catwalk catwalk
soft repo list
stdout catwalk


# check description
soft repo description charmbracelet/catwalk
! stdout .

# set description
soft repo description charmbracelet/catwalk "testing repo"
soft repo description charmbracelet/catwalk
stdout 'testing repo'
readfile $DATA_PATH/repos/charmbracelet/catwalk.git/description 'testing repo'

# rename
soft repo rename charmbracelet/catwalk charmbracelet/test
soft repo list
stdout charmbracelet/test # TODO: shouldn't this still show the project-name?

# check its not private
soft repo private charmbracelet/test
stdout false
exists $DATA_PATH/repos/charmbracelet/test.git/git-daemon-export-ok

# make it private
soft repo private charmbracelet/test  true
soft repo private charmbracelet/test
stdout true
! exists $DATA_PATH/repos/charmbracelet/test.git/git-daemon-export-ok

# check its not hidden
soft repo hidden charmbracelet/test
stdout false

# make it hidden
soft repo hidden charmbracelet/test  true
soft repo hidden charmbracelet/test
stdout true

# print tree
soft repo tree charmbracelet/test
cmp stdout tree.txt

# check repo info again
soft repo info charmbracelet/test
cmp stdout info2.txt

# get a file
soft repo blob charmbracelet/test LICENSE
stdout '.*MIT.*'

# stop the server
[windows] stopserver
[windows] ! stderr .


-- info1.txt --
Project Name:
Repository: charmbracelet/catwalk
Description:
Private: false
Hidden: false
Mirror: true
Owner: admin
Default Branch: main
Branches:
  - main
  - openrouter-update
Tags:
  - v0.4.12
  - v0.4.11
  - v0.4.10
  - v0.4.9
  - v0.4.8
  - v0.4.7
  - v0.4.6
  - v0.4.5
  - v0.4.4
  - v0.4.3
  - v0.4.2
  - v0.4.1
  - v0.4.0
  - v0.3.6
  - v0.3.5
  - v0.3.4
  - v0.3.3
  - v0.3.2
  - v0.3.1
  - v0.3.0
  - v0.2.0
  - v0.1.0
-- info2.txt --
Project Name: catwalk
Repository: charmbracelet/test
Description: testing repo
Private: true
Hidden: true
Mirror: true
Owner: admin
Default Branch: main
Branches:
  - main
  - openrouter-update
Tags:
  - v0.4.12
  - v0.4.11
  - v0.4.10
  - v0.4.9
  - v0.4.8
  - v0.4.7
  - v0.4.6
  - v0.4.5
  - v0.4.4
  - v0.4.3
  - v0.4.2
  - v0.4.1
  - v0.4.0
  - v0.3.6
  - v0.3.5
  - v0.3.4
  - v0.3.3
  - v0.3.2
  - v0.3.1
  - v0.3.0
  - v0.2.0
  - v0.1.0
-- tree.txt --
drwxrwxrwx	-	 .github
drwxrwxrwx	-	 cmd
drwxrwxrwx	-	 internal
drwxrwxrwx	-	 pkg
-rw-r--r--	577 B	 .gitignore
-rw-r--r--	695 B	 .golangci.yml
-rw-r--r--	3.3 kB	 .goreleaser.yaml
-rw-r--r--	1.1 kB	 CRUSH.md
-rw-r--r--	1.1 kB	 LICENSE
-rw-r--r--	1.0 kB	 README.md
-rw-r--r--	528 B	 go.mod
-rw-r--r--	3.0 kB	 go.sum
-rw-r--r--	79 B	 goreleaser.dockerfile
-rw-r--r--	1.7 kB	 main.go
